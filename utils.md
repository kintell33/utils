
# Utils Documentation

## Table of Contents
1. [Linux Commands](#linux-commands)
2. [Python Consumer](#python-consumer)
3. [Jenkins](#jenkins)
4. [Apache](#apache)
5. [MySQL](#mysql)
6. [Symfony](#symfony)
7. [SQL Server](#sql-server)
8. [DotNet](#dotnet)
9. [Git](#git)
10. [WSL](#wsl)
11. [NodeJS](#nodejs)
12. [Electron](#electron)
13. [FortiVPN Client](#fortivpn-client)
14. [Docker](#docker)

---

# UTILS
company Util commands

## LINUX COMMANDS

### pwd
> print actual location
```sh
pwd
$ /home/user
```

### mkdir
> create directory
```sh
mkdir test
cd test
pwd
$ /home/user/test
```
### rmdir
> delete directory
```sh
ls
$ test
rmdir test
ls
$ 
```

### ls
> list files
```sh
#listar con info
ls -l

#archivos ocultos
ls -a
```

### du/df
> disk space
```sh
#espacio libre en megas
df -h

#espacio por carpetas
du -cha --max-depth=1 /folder | grep -E "M|G"
```

### grep
> find in file
 ```sh
 #show 5 lines more
cat file.out.log | grep 'ERROR' -C 5
 ```

### files
> append data to files
```sh
#append text to file
echo "hello world"  >> read.txt   
echo "hello siva" >> read.txt   

cat read.txt
$ hello world
$ hello siva
```

### connect with ssh key
```sh
ssh -i /root/keys/key.pem user@10.0.0.1
```

### uncompress
> descrimprimir archivos .tar
```sh
tar xvf my_file.tar
```

> descomprimir archivos .gz
```sh
gunzip my_file.gz
```

### compress
```sh
cd /var/www/api/current/var/log && lfc=$(date +%H%M%S%d%m%y) && tar -czvf filecompressed.tar.gz file.test file2.test file3.test
```

###  example crompress logs 
> cron to compress all the logs generated by an app day by day
```sh
cd /var/www/api/current/var/log && lfc=$(date +%H%M%S%d%m%y) && tar -czvf $lfc.tar.gz prod.log  servicesFullFail.log  servicesFull.log  services.log  vencimiento.log && rm -rf prod.log  servicesFullFail.log  servicesFull.log  services.log  vencimiento.log
touch services.log
touch servicesFull.log

59 23 * * * cd /var/www/api/config/crons && ./compresslog.sh >/dev/null 2>&1
```

### delete old directories
> for deleting old directories and leave only 3
```sh
ls -t1 /var/path/to/folder | tail -n +4 | xargs rm -rf
```

### tar
> compress and decompress
```sh
#compress file
tar -cf file.tar /folder

#descompress file
tar -xf file.tar
```

### screen 
>run process in background

```sh
#install screen
sudo apt install screen

#create screen to shell script
screen -S nombre_proceso -d -m ./script.sh

#detach screen
#CTRL + A + D

#list screen
screen -ls

#reatach screen
screen -d -R nombre_proceso

#kill all screens
pkill screen
```

### supervisor
> background process execution
```
#install supervisor
sudo apt install supervisor

#start service
service supervisor restart
```
create config file in ****/etc/supervisor/conf.d/file_config.conf****

*file content*
```sh
[program:long_script]
command=/usr/local/bin/script.sh
autostart=true
autorestart=true
stderr_logfile=/var/log/long.err.log
stdout_logfile=/var/log/long.out.log
```
read configuration changes
```sh
#reread config and update
sudo supervisorctl reread
sudo supervisorctl update
```
*create tunnel*
```sh
#3306 is the port to connect
#9797 is the port in my computer
#server.door is the first server
#server.destination is the real destination

ssh -L 9797:server.destination:3306 -f -C -q -N username@server.door
```

## PYTHON CONSUMER

RabbitMQ Python Consumer

```
#!/usr/bin/env python
import pika
import time
import re
import requests
import os
import json

EXCHANGE = "rabbitmq_ex"
QUEUE = "async_mq"

credentials = pika.PlainCredentials('user', '1QAZ2WSX')
vhost = '/vhost_test'
connection = pika.BlockingConnection(pika.ConnectionParameters(host='127.0.0.1',port=5672,credentials=credentials,virtual_host=vhost,heartbeat=600,blocked_connection_timeout=300))
channel = connection.channel()

channel.queue_declare(queue=QUEUE, durable=True)

print(' [*] Escuchando la cola...')

def callback(ch, method, properties, body):
   print "[-] Mensaje recibido"
   body = body.decode('utf-8')
   j = json.loads(body)
   accion_id = j['encoded_accion_id']
   print "- ENCODED ID: '%s'" % accion_id
   try:
    var = "php /var/www/api/current/bin/console pickit:asyncExecute '%s'" % accion_id
    os.system(var)
    print "Ejecutado con exito!"
   except requests.exceptions.ConnectionError:
    print "- Estado de la llamada ConnectionRefused"
   print "- Llamada realizada"
   ch.basic_ack(delivery_tag = method.delivery_tag)

channel.basic_qos(prefetch_count=1)
channel.basic_consume(queue=QUEUE, on_message_callback=callback)

channel.start_consuming()
```

## JENKINS
*recipe for symfony app*
```sh
#check space disk left less that 90 perc.
diskaccept=90 && diskleft=`df -h /dev/sda2 --output=pcent | tail -n 1 | tr 's/%' '\0'` && if [ "$diskaccept" -gt "$diskleft" ]; then exit 0; else exit 1; fi

#git
git_repo=pickit_integration
git_user_pass=${USER_GIT_DEPLOYER}:${PASSWORD_GIT_DEPLOYER}
branch=${GITBRANCH}

#release
release=$(date +%H%M%S%d%m%y)

#folders
app_folder=middleware
config_folder=/var/www/$app_folder/config
shared_folder=/var/www/$app_folder/shared
release_folder=/var/www/$app_folder/releases
public_folder=/var/www/$app_folder
folder=$release_folder/$release

#folder
echo "-> creating folder $folder"
mkdir -p $folder

#clone
echo "-> cloning project branch $branch"
git clone https://$git_user_pass@bitbucket.org/companyits/$git_repo.git $folder --branch $branch

#add new parameters
envparams=${ENVPARAMETERS}
if [ -z "${ENVPARAMETERS}" ];then echo "${ENVPARAMETERS} is empty";else (cd $config_folder && echo $envparams >> parameters.yml);fi

#config
echo "-> symbolic link to configuration"
rm -rf $folder/app/config/parameters.yml
ln -s $config_folder/parameters.yml $folder/app/config/parameters.yml

#composer
echo "-> composer install"
composer install --no-interaction -d $folder

#permissons
echo "-> setting permissons to folders"
chmod -R 777 $folder/var

#assets
echo "-> new asset version"
php $folder/bin/console deploy:increase-asset-version

echo "-> asset copy"
php $folder/bin/console assets:install public --symlink

#cache
echo "->cache clear"
php $folder/bin/console cache:clear  --env=prod

#migrations
echo "-> executing migrations"
rm -rf $folder/var/cache/dev
rm -rf $folder/var/cache/prod
php $folder/bin/console --no-interaction doctrine:migrations:migrate

#cache parte 2
echo "->cache clear"
php $folder/bin/console cache:clear  --env=prod

#publish
echo "-> publishing"
rm -rf $public_folder/current
ln -s $folder $public_folder/current

#clear
echo "-> deleting old releases"
ls -t1 $release_folder | tail -n +4 | xargs rm -rf
echo "-> renaming releases"
cd $release_folder && for i in *; do if [ "$i" != "$release" ]; then mv "$i" "$i"_bkp; fi;done

echo "-> end"
```

*check disk space*
> if disk left in device is greater than 90% its ok to deploy (important: check the name of the partition to use, example /dev/sda2

```sh
#check space disk left
diskaccept=90 && diskleft=`df -h /dev/sda2 --output=pcent | tail -n 1 | tr 's/%' '\0'` && if [ "$diskaccept" -gt "$diskleft" ]; then echo 'disk space OK'; else echo 'no disk space left' && exit 1; fi
```

*merge new env variables *
> adding variables to the config file
 
```sh
#change your new variables from this
APP_RABBIT_HOST='test.server.net'
APP_RABBIT_VHOST=/
APP_RABBIT_PORT=5672
APP_RABBIT_USER='guest'
APP_RABBIT_PASS='guest'

#to this
APP_RABBIT_HOST='test.server.net'\nAPP_RABBIT_VHOST=/\nAPP_RABBIT_PORT=5672\nAPP_RABBIT_USER='guest'\nAPP_RABBIT_PASS='guest'
```

> add the new parameter string to deploy and add the following
```sh
#add new parameters
envparams=${ENVPARAMETERS}
if [ -z "${ENVPARAMETERS}" ];then echo "${ENVPARAMETERS} is empty";else (cd $config_folder && echo $envparams >> .env);fi
```

*delete old releases*
> command delete old releases and leave the last 3 folders created
```sh
echo "-> deleting old releases"
cd $release_folder && ls -t1 $release_folder | tail -n +3 | xargs rm -rf
```

*rename releases command*
> rename all the releases except the actual release to avoid cache problems

```sh
echo "-> renaming releases"
cd $release_folder && for i in *; do if [ "$i" != "$release" ]; then mv "$i" "$i"_bkp; fi;done
```

## APACHE
> util commands when working with apache

*enable rewrite module*
```sh
sudo a2enmod rewrite
```

*restart server*
```sh
sudo service apache2 restart
```
*apache version*
```sh
sudo apache2 -V
```

*check syntax in cfg files*
```sh
sudo apache2ctl -t
```
## MYSQL
> util commands when working with mysql

*connecto to mysql*
```sh
mysql -u root -pPASSWORD
```

*create user*
```sh
CREATE USER 'user'@'localhost' IDENTIFIED BY 'password';
#grant permissons on user
GRANT ALL PRIVILEGES ON *.* TO 'user'@'localhost' IDENTIFIED BY 'password';
```

*get size db tables mysql*
```sh
SELECT table_name AS "Table",
ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES
WHERE table_schema = "database_name"
ORDER BY (data_length + index_length) DESC;
```

*mysql dump*
```sh
mysqldump -u root -p dbName > file.sql
```

*eliminar espacio de tablas*
```sql
--tabla de ejemplo retailer_notificacion_estandar_log
--espacio utilizado por la tabla 1557.27
delete from retailer_notificacion_estandar_log where id < 100000
--espacio utilizado por la tabla 1714.28
optimize table retailer_notificacion_estandar_log
--espacio utilizado por la tabla 539.98
```

## SYMFONY
>working with Symfony

*composer install no interaction*
```sh
composer install --no-interaction -d /path/to/folder
```

*run migrations*
```sh
php bin/console --no-interaction doctrine:migrations:migrate
```

*migrations delete and create table*
```sh
drop table migration_versions;

create table migration_versions (version varchar(255), primary key (version));

insert into migration_versions
values ('20181221211126');
```

*start server symfony*
```sh
php bin/console server:start
```

*delete cache*
```sh
php $folder/bin/console cache:clear  --env=prod
```

## SQLSERVER
> working with sqlserver

*login*
```sh
sqlcmd -S localhost -U user -P 'password'
```

*run command*
```sh
$ select * from user;
$ GO
```

*execute script*
```sh
sqlcmd -S localhost -d database -U username -P 'password' -i script.sql
```

sqlcmd -S localhost -d EAP -U sa -P 'p4$$word01' -i script_1.sql

## DOTNET
> working with dotnet

*run and build*
```sh
#build and run
dotnet run Solution.sln
dotnet run Project.sln

#dotnet build
dotnet build Solution.sln

#dotnet publish
dotnet publish Project.csproj
```

## GIT
> working with GIT

*initialize repo*
```sh
cd /home
git init
```

*check differences with git diff*
```sh
$ git diff hello.txt
diff --git a/hello.txt b/hello.txt
index 557db03..980a0d5 100644
--- a/hello.txt
+++ b/hello.txt
@@ -1 +1 @@
-Hello World
+Hello World!
```

*show git commit logs*
```sh
$ git log
commit 9d63f80111447544c303e9f1776fa08593a87310
Author: codecademy <exampleuser@codecademy.com>
Date:   Wed Jan 13 18:55:53 2021 +0000
 
    Added updates to the file
 
commit 3ba6efbeece6ed530d85de5e313e52123fdf8cb4
Author: codecademy <exampleuser@codecademy.com>
Date:   Wed Jan 6 10:11:13 2021 -0400
 
    Completed first line of dialogue
```

*stage files to commit*
```sh
#stage all my files
git add .
```

*commit code*
```
$ git commit -m "Added About section to README"
[master 9d63f80] Added About section to README
1 file changed, 10 insertions(+), 1 deletion(-)
```

*download repo*
```sh
git checkout gitlab.com/project.git
```

*update brachs*
```sh
git fetch
```

*download changes in my branch*
```sh
#you have to be in the actual branch you want to update
git merge origin/repoupdatewith
```

*upload my changes in my actual branch*
```sh
#check status
git status

#stage all my files
git add .

#commit my changes
git commit -m "commit message"

#push my changes to server
git push
```

*upload changes in a new branch*
```sh
git checkout -b newbranch frombranch
```

*see list of all branchs*
```sh
git branch
```

*discard all my changes*
```sh
git reset --hard
```

*discard specific change*
```sh
git reset /path/to/file
```

*for sync actual branch*
```sh
git merge master
```

*get status*
```sh
git status
```

*git reset with SHA*
```sh
 git log
commit 9d63f80111447544c303e9f1776fa08593a87310
Author: codecademy <exampleuser@codecademy.com>
Date:   Wed Jan 13 18:55:53 2021 +0000
 
    Added updates to the file
 
commit 3ba6efbeece6ed530d85de5e313e52123fdf8cb4
Author: codecademy <exampleuser@codecademy.com>
Date:   Wed Jan 6 10:11:13 2021 -0400
 
    Completed first line of dialogue
 
$ git reset 3ba6efb
```

*remove files from stage*
```sh
$ git reset HEAD scene-3.txt
Unstaged changes after reset:
M       scene-3.txt
```

*rollback to last commit*
```sh
$ git checkout HEAD scene-5.txt
$ git diff
```

## WSL
> utils for windows subsystem linux

*enable wsl on windows*
```sh
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux 
```

*enable specific version of wsl on windows*

You might have to enable Linux to work with WSL version 2. If so, you can do so by following the below instructions.

first check versions
```sh
wsl -l
```

next set the version
```sh
wsl --set-version <distro> 2
```

*unregister distro*
```sh
wsl unregister Ubuntu-18.04
```

*export or import yout distribution to a tar*
```sh
wsl –export Ubuntu ./Test-Ubuntu.tar
```

```sh
wsl –import Test-Ubuntu C:\data\Test-Ubuntu .\Test-Ubuntu.tar
```

## NODEJS
> utils for nodejs

*build*
```sh
node .
```

*install package*
```sh
npm i
```

## ELECTRON
> utils for electron

*build*
```sh
npx electron .
```

*install package*
```sh
npm i
```


## FORTIVPN CLIENT

```
sudo apt install openfortivpn
```

Luego crear el archivo de configuracion y completar la configuracion

```
root@Jenkins:~# touch openfortivpn.conf
root@Jenkins:~# chmod go= openfortivpn.conf
root@Jenkins:~# vi openfortivpn.conf
```

```
host = vpn.server.net
port = 443
username = tester
password = c0ntr4$3ñ4
```

Conectarse al servidor de VPN

```
sudo openfortivpn -c openfortivpn.conf
```

Nos va a dar un error como el siguiente donde pasa una linea mas para agregar a la configuracion con un token

```
ERROR:  Gateway certificate validation failed, and the certificate digest in not in the local whitelist. If you trust it, rerun with:
ERROR:      --trusted-cert e7e47c513b19914ed9acc56e262223423423423497e4fd33e8012c0ac
ERROR:  or add this line to your config file:
ERROR:      trusted-cert = e7e47c513b19914ed9acc56e262223423423423497e4fd33e8012c0ac
```

Agregar la configuracion a archivo que finalmente quedara de la siguiente forma:

```
host = vpn.server.net
port = 443
username = tester
password = c0ntr4$3ñ4
trusted-cert = e7e47c513b19914ed9acc56e262223423423423497e4fd33e8012c0ac
```

Ahora si conectarse sin problemas

```
sudo openfortivpn -c openfortivpn.conf
```

Se se desea ver mas log agregar el parametro -v

> POSIBLES ERRORES
>
>** Credenciales invalidas **
>
>ERROR:  Could not authenticate to gateway (No cookie given).
>
>** No esta instalado PPP **
>
>ERROR:  /usr/sbin/pppd: No such file or directory.
>
>SOLUCION:
>sudo apt install ppp

## DOCKER

permisos a usuario docker

> es posible que ya este agregado

```
sudo groupadd docker
```

Por ultimo ejecutar el siguiente comando

```
sudo gpasswd -a $USER docker
```
Desloguearse y loguearse nuevamente para activar los cambios en los grupos

Para probar ejecute el siguiente comando

```
docker run hello-world
```

buildear un proyecto
```
docker-compose build
```

iniciar un proyecto
```
docker-compose run -d
```

listar containers
```
docker container ls -a
```

detener un container
```
docker container stop [container_id]
```

detener todos los containers
```
docker container stop $(docker container ls –aq)
```

eliminar container
```
docker container rm [container_id]
```

eliminar todos los containers detenidos
```
docker container rm $(docker container ls –aq)
```

obtener imagenes
```
docker image ls
```

eliminar imagenes
```
docker image rm [image_id1] [image_id2]
```

listar volumenes
```
docker volume ls
```

elimianr un volumen
```
docker volume rm VolumeName
```

abrir terminal dentro del contenedor (ubuntu)
```
docker exec -it CONTAINER_NAME bash
```

buildear y correr un contenedor en una linea
```
docker run -it --rm $(docker build -q .)
```

<br></br>

### Dockerfile

#### Instrucciones:


> FROM
Imagen de base, sobre esta se agregaran los cambios que esten por debajo en el dockerfile y se buildea la nueva imagen.
```
FROM <image>:<tag> AS <name>
```
---

> LABEL
Agregar informacion a una imagen a traves de la metadata.
Estos valores son visibles cuando inspeccionamos la imagen o el contenedor
(docker inspect container_name/image_name)
```
LABEL <key>=<value>
```
```
LABEL version="1.1"
LABEL release-date="01-12-2021"
```

---

> ARG
Definir variables de entorno POR DEFECTO que utiliza el dockerfile para buildear la imagen (se pueden modificar pasandolas en el docker run)

```
ARG <key>=<value>
```

---

> ENV
Definir variables de entorno para que esten disponibles en la ejecucion del contenedor (no se pueden modificar en el docker run)

```
ENV <key>=<value>
```
---
> RUN
Se ejecuta el comando mientras se buildea y se crea una nueva capa de la imagen con los cambios.

```
RUN <command>
```
---

> COPY <src> <dest>
Copia archivos/carpetas desde <src> al filesystem del contenedodor en la ruta <dest>

```
COPY <src> <dest>
```
```
COPY ./folder ./var
COPY . .
```

---
  
> EXPOSE 80
Expone el puerto del contenedor contra el host solo si en el docker run posee el flag -F. 
Si el docker run tiene -p (ej. -p 80:80) el puerto expuesto se sobreescribe
```
EXPOSE 80
EXPOSE 80/tcp
```
---
  
> CMD
Comando que se ejecutara al correr el contenedor (la interfaz donde se ejecutara sera la definida en el ENTRYPOINT)

```
   ENTRYPOINT [ "python3" ]
   CMD [ "app.py" ]
```
  
<br></br>


### Docker-compose

docker-compose.yml ejemplo symfony

```
version: '3.1'
services:

  symfony:
    # base image: php:7.2-apache
    build:
      context: .
      dockerfile: Dockerfile-symfony
    volumes:
      - .:/var/www/html:z
    depends_on:
      - mysql
    ports:
      - 81:80

  mysql:
    image: mysql:5.7.30
    ports:
      - 3306:3306
    volumes:
      - mysql-data:/var/lib/mysql

    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_USER: symfony
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: symfony

volumes:
  mysql-data:
```

```
ServerName localhost

<VirtualHost *:80>
    DocumentRoot /var/www/html/public
    DirectoryIndex /index.php

    <Directory /var/www/html/public>
        AllowOverride None
        Order Allow,Deny
        Allow from All

        FallbackResource /index.php
    </Directory>

    <Directory /var/www/html/public/bundles>
        FallbackResource disabled
    </Directory>
    ErrorLog /var/log/apache2/project_error.log
    CustomLog /var/log/apache2/project_access.log combined

</VirtualHost>
```


<br></br>

  
### Dockerfile ejemplo symfony

```
FROM php:7.4.12-apache

COPY --from=composer:latest /usr/bin/composer /usr/local/bin/composer

RUN apt-get update && apt-get install -y git zip unzip \
 && docker-php-ext-install bcmath pdo_mysql

RUN rm -rf /etc/apache2/sites-available/000-default.conf

COPY ./symfony.apache.conf /etc/apache2/sites-available/000-default.conf
```


<br></br>
  
### Dockerfile para python

```sh
FROM python:3.6.1-alpine
WORKDIR /project
ADD . /project
RUN pip install -r requirements.txt
RUN mkdir temp
CMD ["python3", "api.py"]
```

<br></br>
  
### docker-compose.yml para Python
```yml
version: '3.1'
services:

  aplication:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
    - ./exports:/project/exports
    ports:
      - 5000:5000
```

add docker repository insecures to daemon.json

> In the folder `/etc/docker/` ad a new file called daemon.json

example file `daemon.json`
```
{"insecure-registries":["nexus.server.net:10001","nexus.server.net:10002","nexus.server.net:10003","nexus.server.net:10004","nexus.server.net:10005","nexus.server.net:10006","nexus.server.net:10007","nexus.server.net:10008","nexus.server.net:10009"]}
```

login to docker repository (nexus)

`docker login nexus.server.net:10001`

then use your username and password

Then you need to restart the docker service and thats it!